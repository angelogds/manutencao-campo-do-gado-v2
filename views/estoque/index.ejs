<% layout('layout') %>

<div class="page-head">
  <div>
    <h1>Estoque</h1>
    <p class="muted">Controle de itens e movimentações (entrada/saída).</p>
  </div>

  <a class="btn btn-green" href="/estoque/novo">+ Novo item</a>
</div>

<!-- CARDS (3 colunas) -->
<div style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:14px; margin-bottom:14px;">
  <div class="card">
    <div class="label">Itens cadastrados</div>
    <div style="font-size:26px; font-weight:900; margin-top:6px;">
      <%= cards?.itens_estoque ?? 0 %>
    </div>
  </div>

  <div class="card">
    <div class="label">Abaixo do mínimo</div>
    <div style="font-size:26px; font-weight:900; margin-top:6px;">
      <%= cards?.abaixo_minimo ?? 0 %>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn btn-ghost btn-sm" href="/estoque?below=1">Ver abaixo do mínimo</a>
      <% if (onlyBelow) { %>
        <a class="btn btn-ghost btn-sm" href="/estoque">Limpar</a>
      <% } %>
    </div>
  </div>

  <div class="card">
    <div class="label">Saldo total (soma)</div>
    <div style="font-size:26px; font-weight:900; margin-top:6px;">
      <%= Number(cards?.saldo_total ?? 0).toFixed(0) %>
    </div>
    <div class="muted" style="margin-top:6px;">Indicador geral (não financeiro).</div>
  </div>
</div>

<!-- BUSCA -->
<div class="card" style="margin-bottom:14px;">
  <form class="row" method="GET" action="/estoque" style="justify-content:space-between;">
    <div style="flex:1; min-width:260px;">
      <input class="input" name="q" value="<%= q || '' %>" placeholder="Buscar por nome ou código..." />
      <% if (onlyBelow) { %>
        <input type="hidden" name="below" value="1" />
      <% } %>
    </div>

    <div style="display:flex; gap:10px;">
      <button class="btn btn-ghost btn-sm" type="submit">Buscar</button>
      <% if (q) { %>
        <a class="btn btn-ghost btn-sm" href="/estoque<%= onlyBelow ? '?below=1' : '' %>">Limpar</a>
      <% } %>
    </div>
  </form>
</div>

<!-- TABELA -->
<div class="card">
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th style="width:90px;">#</th>
          <th style="width:140px;">Código</th>
          <th>Item</th>
          <th style="width:110px;">Unid.</th>
          <th style="width:130px;">Mínimo</th>
          <th style="width:130px;">Saldo</th>
          <th style="width:110px; text-align:right;">Ações</th>
        </tr>
      </thead>

      <tbody>
        <% if (!lista || !lista.length) { %>
          <tr>
            <td colspan="7" class="muted" style="text-align:center; padding:22px;">
              Nenhum item encontrado.
            </td>
          </tr>
        <% } else { %>

          <% (lista || []).forEach(i => { 
               const below = Number(i.saldo) < Number(i.estoque_min || 0);
          %>
            <tr>
              <td><%= i.id %></td>
              <td><%= i.codigo || '-' %></td>
              <td><%= i.nome %></td>
              <td><%= i.unidade || 'un' %></td>
              <td><%= Number(i.estoque_min || 0) %></td>

              <td>
                <% if (below) { %>
                  <span class="pill-tag pill-amber"><%= Number(i.saldo || 0) %></span>
                <% } else { %>
                  <span class="pill-tag pill-green"><%= Number(i.saldo || 0) %></span>
                <% } %>
              </td>

              <td style="text-align:right;">
                <a class="btn btn-ghost btn-sm" href="/estoque/<%= i.id %>">Abrir</a>
              </td>
            </tr>
          <% }) %>

        <% } %>
      </tbody>
    </table>
  </div>
</div>

<style>
  @media (max-width: 980px){
    /* 3 cards viram 1 coluna no mobile */
    div[style*="grid-template-columns:repeat(3"]{ grid-template-columns:1fr !important; }
  }
</style>

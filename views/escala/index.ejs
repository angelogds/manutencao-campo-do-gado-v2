<% layout("layout") %>

<style>
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px}
  .muted{color:#6b7280}
  .btn{display:inline-block;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;font-weight:800;cursor:pointer}
  .btn:hover{border-color:#16a34a;color:#16a34a}
  .btn-primary{background:#16a34a;color:#fff;border-color:#16a34a}
  .btn-primary:hover{filter:brightness(.95);color:#fff}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
  @media (max-width: 980px){.grid{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px}
  th{font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.04em}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f3f4f6;font-weight:800;font-size:12px}
</style>

<h1>Escala</h1>
<p class="muted" style="margin-top:-6px;">Semana inteira • <strong><%= range.monday %></strong> até <strong><%= range.sunday %></strong></p>

<div class="row" style="margin:10px 0 14px;">
  <form method="GET" action="/escala" class="row" style="margin:0;">
    <div>
      <label class="muted" style="font-size:12px;font-weight:800;">Ver semana da data</label><br/>
      <input name="date" type="date" value="<%= (range?.today || '') %>" class="btn" style="height:40px"/>
    </div>
    <button class="btn" type="submit">Carregar</button>
  </form>

  <a class="btn btn-primary" href="/escala/pdf?<%= (range?.today ? ('date=' + range.today) : '') %>">Gerar PDF</a>
</div>

<div class="grid">
  <div class="card">
    <h3 style="margin:0 0 6px;">Alocações da semana</h3>
    <div class="muted" style="margin-bottom:10px;">Noturno / Diurno / Apoio / Plantão</div>

    <table>
      <thead>
        <tr>
          <th>Turno</th>
          <th>Colaborador</th>
          <th>Função</th>
          <th>Horário</th>
          <th>Obs</th>
        </tr>
      </thead>
      <tbody>
        <% if (!alocacoes?.length) { %>
          <tr><td colspan="5" class="muted">Sem registros nesta semana.</td></tr>
        <% } %>

        <% alocacoes.forEach(a => { %>
          <tr>
            <td><span class="pill"><%= (a.tipo_turno || '').toUpperCase() %></span></td>
            <td><%= a.colaborador_nome %></td>
            <td class="muted"><%= a.colaborador_funcao %></td>
            <td><%= (a.horario_inicio && a.horario_fim) ? (a.horario_inicio + " - " + a.horario_fim) : "-" %></td>
            <td class="muted"><%= a.observacao || "-" %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin:0 0 6px;">Adicionar alocação (Admin)</h3>
    <div class="muted" style="margin-bottom:10px;">Por enquanto só o ADMIN altera.</div>

    <form method="POST" action="/escala">
      <input type="hidden" name="semana_id" value="<%= semana.id %>"/>

      <label class="muted" style="font-size:12px;font-weight:800;">Tipo de turno</label><br/>
      <select name="tipo_turno" class="btn" style="width:100%;height:40px">
        <option value="noturno">Noturno</option>
        <option value="diurno">Diurno</option>
        <option value="apoio">Apoio Operacional</option>
        <option value="plantao">Plantão</option>
        <option value="folga">Folga</option>
      </select>

      <div style="display:flex;gap:10px;margin-top:10px;">
        <div style="flex:1">
          <label class="muted" style="font-size:12px;font-weight:800;">Início</label><br/>
          <input name="horario_inicio" type="time" class="btn" style="width:100%;height:40px"/>
        </div>
        <div style="flex:1">
          <label class="muted" style="font-size:12px;font-weight:800;">Fim</label><br/>
          <input name="horario_fim" type="time" class="btn" style="width:100%;height:40px"/>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label class="muted" style="font-size:12px;font-weight:800;">Colaborador</label><br/>
        <select name="colaborador_id" class="btn" style="width:100%;height:40px">
          <% colaboradores.forEach(c => { %>
            <option value="<%= c.id %>"><%= c.nome %> • <%= c.funcao %></option>
          <% }) %>
        </select>
      </div>

      <div style="margin-top:10px;">
        <label class="muted" style="font-size:12px;font-weight:800;">Observação</label><br/>
        <input name="observacao" class="btn" style="width:100%;height:40px" placeholder="Ex: apoio operacional, substituição, etc"/>
      </div>

      <button class="btn btn-primary" style="margin-top:12px;width:100%;" type="submit">Salvar</button>
    </form>
  </div>
</div>

<%- layout('layout') -%>

<div class="page-head" style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
  <div>
    <h1 style="margin:0;">Escala</h1>
    <p style="margin:6px 0 0;color:#64748b;font-weight:700;">
      Publicações oficiais (PDF) + escala semanal do sistema.
    </p>
  </div>

  <% if (semana) { %>
    <div style="display:flex;gap:10px;align-items:center;">
      <a class="btn btn-primary" href="/escala/pdf/semana/<%= semana.id %>">Gerar PDF da Semana</a>
      <a class="btn" href="/dashboard">Voltar</a>
    </div>
  <% } %>
</div>

<!-- Publicações -->
<div class="card" style="margin-top:14px;">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h3 style="margin:0;">Publicações</h3>
      <div style="color:#64748b;font-weight:700;margin-top:4px;">Escalas prontas para consulta (ex.: 2026).</div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <table class="table">
      <thead>
        <tr>
          <th>Título</th>
          <th style="width:160px;">Criada em</th>
          <th style="width:140px;">Ações</th>
        </tr>
      </thead>
      <tbody>
        <% if (!publicacoes || publicacoes.length === 0) { %>
          <tr><td colspan="3" style="text-align:center;color:#64748b;">Nenhuma publicação cadastrada.</td></tr>
        <% } else { %>
          <% publicacoes.forEach(p => { %>
            <tr>
              <td><%= p.titulo %></td>
              <td><%= (p.created_at || '').slice(0,10) %></td>
              <td>
                <a class="btn btn-sm" href="/escala/publicacoes/<%= p.id %>">Abrir</a>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- Semana do sistema -->
<div class="card" style="margin-top:14px;">
  <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;">
    <div>
      <h3 style="margin:0;">Semana do Sistema</h3>
      <% if (semana) { %>
        <div style="margin-top:6px;color:#334155;font-weight:800;">
          Período: <%= semana.data_inicio %> até <%= semana.data_fim %>
        </div>
      <% } else { %>
        <div style="margin-top:6px;color:#b91c1c;font-weight:900;">
          Sem semana cadastrada para esta data.
        </div>
      <% } %>
    </div>

    <div style="display:flex;gap:10px;align-items:center;">
      <form method="GET" action="/escala" style="display:flex;gap:8px;align-items:center;">
        <input type="date" name="date" value="<%= alvo %>" class="input" style="height:38px;">
        <button class="btn btn-sm" type="submit">Ir</button>
        <a class="btn btn-sm" href="/escala?date=<%= (new Date()).toISOString().slice(0,10) %>">Hoje</a>
      </form>
    </div>
  </div>

  <div style="margin-top:12px;">
    <table class="table">
      <thead>
        <tr>
          <th style="width:160px;">Data</th>
          <th>Colaborador</th>
          <th style="width:140px;">Turno</th>
          <th style="width:160px;">Setor</th>
          <th style="width:240px;">Status</th>
          <th style="width:120px;">Ações</th>
        </tr>
      </thead>
      <tbody>
        <% if (!semana || !semana.linhas || semana.linhas.length === 0) { %>
          <tr>
            <td colspan="6" style="text-align:center;color:#64748b;">Nenhum item cadastrado nesta semana.</td>
          </tr>
        <% } else { %>
          <% semana.linhas.forEach(l => { %>
            <tr>
              <td><%= semana.data_inicio %> a <%= semana.data_fim %></td>
              <td style="font-weight:900;"><%= l.nome %></td>
              <td><%= l.turnoLabel %></td>
              <td><%= l.setor %></td>
              <td><%= l.statusLabel %></td>
              <td>
                <a class="btn btn-sm" href="/escala/editar/<%= semana.id %>">Editar</a>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <hr style="margin:16px 0;border:0;border-top:1px solid #e5e7eb;">

  <!-- Adicionar rápido -->
  <h4 style="margin:0 0 10px;">Adicionar rápido (opcional):</h4>
  <form method="POST" action="/escala/adicionar" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
    <input type="hidden" name="date" value="<%= alvo %>">
    <div style="min-width:200px;">
      <div class="label">DATA</div>
      <input class="input" type="date" name="date" value="<%= alvo %>">
    </div>
    <div style="flex:1;min-width:220px;">
      <div class="label">COLABORADOR</div>
      <input class="input" name="nome" placeholder="Ex.: Emanuel">
    </div>
    <div style="min-width:180px;">
      <div class="label">TURNO</div>
      <select class="input" name="turno">
        <option value="">Selecione</option>
        <option value="Dia">Dia</option>
        <option value="Noite">Noite</option>
        <option value="Apoio">Apoio</option>
      </select>
    </div>
    <div style="min-width:220px;">
      <div class="label">SETOR</div>
      <input class="input" name="setor" value="Manutenção">
    </div>

    <button class="btn btn-primary" type="submit">Salvar</button>
  </form>

  <hr style="margin:16px 0;border:0;border-top:1px solid #e5e7eb;">

  <!-- Folga / Atestado -->
  <h4 style="margin:0 0 10px;">Folga / Atestado (por período):</h4>
  <form method="POST" action="/escala/ausencia" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
    <input type="hidden" name="date" value="<%= alvo %>">
    <div style="flex:1;min-width:220px;">
      <div class="label">COLABORADOR</div>
      <input class="input" name="nome" placeholder="Ex.: Diogo">
    </div>
    <div style="min-width:180px;">
      <div class="label">TIPO</div>
      <select class="input" name="tipo">
        <option value="folga">Folga</option>
        <option value="atestado">Atestado</option>
      </select>
    </div>
    <div style="min-width:200px;">
      <div class="label">INÍCIO</div>
      <input class="input" type="date" name="inicio">
    </div>
    <div style="min-width:200px;">
      <div class="label">FIM</div>
      <input class="input" type="date" name="fim">
    </div>
    <div style="flex:1;min-width:220px;">
      <div class="label">MOTIVO (opcional)</div>
      <input class="input" name="motivo" placeholder="Ex.: Atestado médico / Folga programada">
    </div>
    <button class="btn btn-primary" type="submit">Lançar</button>
  </form>

  <div style="margin-top:14px;color:#64748b;font-weight:700;">
    PDF por período: use <code>/escala/pdf?start=YYYY-MM-DD&end=YYYY-MM-DD</code>
  </div>
</div>

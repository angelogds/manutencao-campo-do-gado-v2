<% layout('layout') %>

<style>
  .dashboard-stack { display:grid; gap:14px; }
  .dash-row { display:grid; grid-template-columns: 1.4fr 1fr; gap:14px; align-items:stretch; }

  .dashboard-card {
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:12px;
    box-shadow:0 1px 2px rgba(15,23,42,.04);
    min-height: 150px;
  }

  .dashboard-title {
    font-size:13px;
    font-weight:900;
    letter-spacing:.04em;
    color:#475569;
    text-transform:uppercase;
    margin-bottom:10px;
  }

  .kpi-grid { display:grid; grid-template-columns:repeat(3,minmax(120px,1fr)); gap:8px; margin-bottom:10px; }
  .kpi-grid.two { grid-template-columns:repeat(2,minmax(120px,1fr)); margin-bottom:0; }
  .kpi-box { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fafafa; }
  .kpi-label { font-size:12px; color:#64748b; }
  .kpi-value { margin-top:2px; font-size:26px; font-weight:900; line-height:1.1; color:#0f172a; }

  .table-wrap { overflow:auto; }
  .table.compact th,.table.compact td { padding:8px; vertical-align:middle; font-size:13px; }
  .table.compact thead th { background:#f8fafc; }
  .muted-xs { font-size:12px; color:#64748b; }

  .pagination { display:flex; justify-content:space-between; align-items:center; margin-top:10px; gap:8px; flex-wrap:wrap; }
  .btn-outline { border:1px solid #d1d5db; border-radius:9px; padding:6px 10px; background:#fff; color:#0f172a; text-decoration:none; font-weight:700; font-size:12px; }
  .btn-inline { border:none; border-radius:8px; padding:5px 9px; background:#16a34a; color:#fff; font-weight:800; cursor:pointer; font-size:12px; }

  .aviso-item { border:1px solid #e5e7eb; border-radius:10px; padding:9px 10px; background:#fff; margin-top:8px; }
  .list-tight { margin:8px 0 0 16px; padding:0; }
  .list-tight li { margin-bottom:4px; }

  .quick-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

  .os-card { min-height: 320px; }
  .mural-card, .preventivas-card, .escala-card { min-height: 0; }

  @media (max-width: 1200px) {
    .dash-row { grid-template-columns:1fr; }
  }

  @media (max-width: 760px) {
    .kpi-grid, .kpi-grid.two, .quick-grid { grid-template-columns:1fr; }
  }
</style>

<%
  var safeCards = cards || {};
  var safeComprasResumo = comprasResumo || {};
  var safeDemandasResumo = demandasResumo || {};
  var demandasEmTrabalho = safeDemandasResumo.em_trabalho || [];
  var safeEstoqueResumo = estoqueResumo || {};
  var estoqueMovimentacoes = safeEstoqueResumo.ultimas_movimentacoes || [];
  var safeOSResumo = osResumo || {};
  var safeOSPainel = osPainel || {};
  var osItems = safeOSPainel.items || [];
  var safeAvisos = avisos || [];
  var safeEscala = escala || {};
  var escalaDiurno = (safeEscala.diurno_mecanicos || []).map(function(p) { return p.nome; }).join(', ');
  var escalaApoio = (safeEscala.apoio_operacional || []).map(function(p) { return p.nome; }).join(', ');
  var escalaNoturno = (safeEscala.noturno || []).map(function(p) { return p.nome; }).join(', ');
  var safeMotoresResumo = motoresResumo || {};
%>

<div class="page-head">
  <div>
    <h1>Painel</h1>
    <p class="muted">Operacional Reciclagem</p>
  </div>
</div>

<div class="dashboard-stack">
  <div class="dash-row">
    <div class="dashboard-card os-card">
      <div class="dashboard-title">Ordem de Serviço</div>
      <div class="kpi-grid">
        <div class="kpi-box"><div class="kpi-label">Abertas</div><div class="kpi-value"><%= safeOSResumo.abertas || 0 %></div></div>
        <div class="kpi-box"><div class="kpi-label">Em andamento</div><div class="kpi-value"><%= safeOSResumo.andamento || 0 %></div></div>
        <div class="kpi-box"><div class="kpi-label">Fechadas</div><div class="kpi-value"><%= safeOSResumo.fechadas || 0 %></div></div>
      </div>

      <div class="table-wrap">
        <table class="table compact">
          <thead><tr><th>#</th><th>Equipamento</th><th>Descrição</th><th>Tipo</th><th>Status</th><th style="text-align:right;">Ações</th></tr></thead>
          <tbody>
            <% if (osItems.length === 0) { %>
              <tr><td colspan="6" style="text-align:center; color:#6b7280;">Nenhuma OS cadastrada.</td></tr>
            <% } %>
            <% osItems.forEach(function(o) { %>
              <tr>
                <td><%= o.id %></td>
                <td><strong><%= o.equipamento || '-' %></strong></td>
                <td><%= o.descricao || '-' %></td>
                <td><span class="pill-tag pill-blue"><%= (o.tipo || '-').toUpperCase() %></span></td>
                <td>
                  <% var statusOs = String(o.status || '').toUpperCase(); %>
                  <% if (statusOs === 'ABERTA') { %><span class="pill-tag pill-amber">Aberta</span>
                  <% } else if (statusOs === 'ANDAMENTO') { %><span class="pill-tag pill-blue">Em andamento</span>
                  <% } else if (statusOs === 'PAUSADA') { %><span class="pill-tag pill-gray">Pausada</span>
                  <% } else if (statusOs === 'CONCLUIDA' || statusOs === 'FINALIZADA') { %><span class="pill-tag pill-green">Fechada</span>
                  <% } else { %><span class="pill-tag pill-gray"><%= statusOs || '-' %></span><% } %>
                </td>
                <td style="text-align:right;">
                  <% if (statusOs === 'ABERTA') { %>
                    <form method="POST" action="/os/<%= o.id %>/status" style="display:inline;">
                      <input type="hidden" name="status" value="ANDAMENTO">
                      <button class="btn-inline" type="submit">Iniciar</button>
                    </form>
                  <% } else { %>
                    <a class="btn-outline" href="/os/<%= o.id %>">Ver</a>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <div class="muted-xs">Mostrando <strong><%= osItems.length || 0 %></strong> de <strong><%= safeOSPainel.total || 0 %></strong>.</div>
        <div style="display:flex; gap:6px;">
          <% if (safeOSPainel.hasPrev) { %><a class="btn-outline" href="/dashboard?page=<%= safeOSPainel.page - 1 %>">Anterior</a><% } %>
          <span class="btn-outline" style="pointer-events:none; opacity:.8;">Página <%= safeOSPainel.page || 1 %> de <%= safeOSPainel.totalPages || 1 %></span>
          <% if (safeOSPainel.hasNext) { %><a class="btn-outline" href="/dashboard?page=<%= safeOSPainel.page + 1 %>">Próxima</a><% } %>
        </div>
      </div>

    <div class="dashboard-card mural-card">
      <div class="muted-xs" style="margin-top:-4px; margin-bottom:8px;">Comunicados rápidos da empresa</div>
      <div class="dashboard-title">Mural</div>
      <% if (safeAvisos.length === 0) { %>
        <p class="muted" style="margin:0;">Sem avisos publicados.</p>
      <% } else { %>
        <% safeAvisos.slice(0, 8).forEach(function(a) { %>
          <div class="aviso-item">
            <div style="font-weight:800;"><%= a.titulo %></div>
            <div class="muted" style="margin-top:3px;"><%= a.mensagem %></div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>

  <div class="dash-row">
    <div class="dashboard-card preventivas-card">
      <div class="dashboard-title">Preventivas Programadas</div>
      <% if (!preventivas || preventivas.length === 0) { %>
        <p class="muted" style="margin:0;">Nenhuma preventiva pendente.</p>
      <% } else { %>
        <div class="table-wrap">
          <table class="table compact">
            <thead><tr><th>Equipamento</th><th>Resp.</th><th>Data</th><th>Status</th><th>Obs</th></tr></thead>
            <tbody>
              <% preventivas.forEach(function(p) { %>
                <tr>
                  <td><strong><%= p.equipamento_nome || '-' %></strong></td>
                  <td><%= p.responsavel || '-' %></td>
                  <td><%= p.data_prevista || '-' %></td>
                  <td><span class="pill-tag pill-gray"><%= p.status || '-' %></span></td>
                  <td><%= p.observacao || '-' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

    <div class="dashboard-card escala-card">
      <div class="dashboard-title">Escala da Semana</div>
      <% if (escalaDiurno || escalaApoio || escalaNoturno) { %>
        <div class="muted-xs" style="margin-bottom:8px;">Semana #<%= safeEscala.semana_numero || '-' %> • <%= safeEscala.data_inicio || '-' %> até <%= safeEscala.data_fim || '-' %></div>
        <table class="table compact">
          <tbody>
            <tr><td><strong>Dia (mecânicos)</strong></td><td><%= escalaDiurno || '-' %></td></tr>
            <tr><td><strong>Apoio operacional</strong></td><td><%= escalaApoio || '-' %></td></tr>
            <tr><td><strong>Noite (responsável)</strong></td><td><%= escalaNoturno || '-' %></td></tr>
          </tbody>
        </table>
      <% } else { %>
        <p class="muted" style="margin:0;">Escala não disponível.</p>
      <% } %>
    </div>
  </div>

  <div class="dash-row">
    <div class="dashboard-card">
      <div class="dashboard-title">Demandas</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
        <span class="pill-tag pill-blue">Novas: <%= safeDemandasResumo.novas || 0 %></span>
        <span class="pill-tag pill-amber">Em andamento: <%= safeDemandasResumo.em_andamento || 0 %></span>
        <span class="pill-tag pill-gray">Paradas: <%= safeDemandasResumo.paradas || 0 %></span>
      </div>
      <ul class="list-tight">
        <% if (demandasEmTrabalho.length === 0) { %><li class="muted-xs">Nenhuma demanda em andamento.</li><% } %>
        <% demandasEmTrabalho.slice(0, 4).forEach(function(d) { %>
          <li><a href="/demandas/<%= d.id %>">#<%= d.id %> - <%= d.titulo %></a></li>
        <% }) %>
      </ul>
    </div>

    <div class="quick-grid">
      <div class="dashboard-card">
        <div class="dashboard-title">Equipamentos</div>
        <div class="kpi-grid two">
          <div class="kpi-box"><div class="kpi-label">Ativos</div><div class="kpi-value"><%= safeCards.equipamentos_ativos || 0 %></div></div>
          <div class="kpi-box"><div class="kpi-label">Inativos</div><div class="kpi-value"><%= safeCards.equipamentos_inativos || 0 %></div></div>
        </div>
      </div>

      <div class="dashboard-card">
        <div class="dashboard-title">Solicitações / Compras</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
          <span class="pill-tag pill-amber">Abertas: <%= safeComprasResumo.solicitacoes_abertas || 0 %></span>
          <span class="pill-tag pill-blue">Aprovadas: <%= safeComprasResumo.solicitacoes_aprovadas || 0 %></span>
        </div>
      </div>

      <div class="dashboard-card">
        <div class="dashboard-title">Estoque (Resumo)</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
          <span class="pill-tag pill-green">Ativos: <%= safeEstoqueResumo.itens_ativos || 0 %></span>
          <span class="pill-tag pill-amber">Abaixo mín.: <%= safeEstoqueResumo.abaixo_minimo || 0 %></span>
        </div>
        <ul class="list-tight">
          <% if (estoqueMovimentacoes.length === 0) { %><li class="muted-xs">Sem movimentações.</li><% } %>
          <% estoqueMovimentacoes.slice(0, 2).forEach(function(m) { %><li><%= (m.tipo || '-').toUpperCase() %> • <%= m.item_nome %></li><% }) %>
        </ul>
      </div>

      <div class="dashboard-card">
        <div class="dashboard-title">Motores</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
          <span class="pill-tag pill-green">Funcionando: <%= safeMotoresResumo.em_funcionamento || 0 %></span>
          <span class="pill-tag pill-blue">Estoque: <%= safeMotoresResumo.em_estoque || 0 %></span>
          <span class="pill-tag pill-amber">Conserto: <%= safeMotoresResumo.em_conserto || 0 %></span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card" style="min-height:320px; margin-top:16px;">
  <div class="label">Preventivas Programadas</div>
      <% if (!preventivas || preventivas.length === 0) { %>
        <div class="muted" style="margin-top:16px;">Nenhuma preventiva pendente.</div>
      <% } else { %>
        <div class="table-wrap" style="margin-top:14px; max-height:420px; overflow:auto;">
          <table class="table compact">
            <thead>
              <tr>
                <th>Equipamento</th>
                <th>Resp.</th>
                <th>Data</th>
                <th>Status</th>
                <th>Obs</th>
              </tr>
            </thead>
            <tbody>
              <% preventivas.forEach((p) => { %>
                <tr>
                  <td><strong><%= p.equipamento_nome || '-' %></strong></td>
                  <td><%= p.responsavel || '-' %></td>
                  <td><%= p.data_prevista || '-' %></td>
                  <td>
                    <% const st = (p.status || '').toLowerCase(); %>
                    <% if (st === 'pendente') { %>
                      <span class="pill-tag pill-blue">Programada</span>
                    <% } else if (st === 'em_andamento' || st === 'andamento') { %>
                      <span class="pill-tag pill-amber">Em andamento</span>
                    <% } else if (st === 'atrasada') { %>
                      <span class="pill-tag pill-amber">Atrasada</span>
                    <% } else { %>
                      <span class="pill-tag pill-gray"><%= p.status || '-' %></span>
                    <% } %>
                  </td>
                  <td class="td-clip"><%= p.observacao || '-' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
</div>
<% layout('layout') %>

<div class="page">

  <!-- HEADER -->
  <div class="page-header" style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h2 style="margin:0;">Motor #<%= motor.id %></h2>
      <small style="color:#777;">Detalhes do motor</small>
    </div>
    <a class="btn btn-secondary" href="/motores">Voltar</a>
  </div>

  <!-- DADOS PRINCIPAIS -->
  <div class="card" style="margin-top:20px;">
    <div class="grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px;">

      <div>
        <label>Código</label>
        <div class="field-value"><%= motor.codigo || '-' %></div>
      </div>

      <div>
        <label>Descrição</label>
        <div class="field-value"><%= motor.descricao %></div>
      </div>

      <div>
        <label>Potência (CV)</label>
        <div class="field-value"><%= motor.potencia_cv ?? '-' %></div>
      </div>

      <div>
        <label>RPM</label>
        <div class="field-value"><%= motor.rpm ?? '-' %></div>
      </div>

      <div>
        <label>Origem</label>
        <div class="field-value"><%= motor.origem_unidade %></div>
      </div>

      <div>
        <label>Status</label>
        <div class="field-value">
          <span class="badge badge-status"><%= motor.status %></span>
        </div>
      </div>

      <div style="grid-column: 1 / -1;">
        <label>Local de Instalação</label>
        <div class="field-value"><%= motor.local_instalacao || '-' %></div>
      </div>

    </div>
  </div>


  <!-- ENVIO / RETORNO -->
  <div class="grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">

    <!-- ENVIAR -->
    <div class="card">
      <h3 style="margin-top:0;">Enviar para Rebobinamento</h3>

      <form method="POST" action="/motores/<%= motor.id %>/enviar" class="form-grid">

        <div>
          <label>Empresa *</label>
          <input name="empresa_rebob" required placeholder="Ex: Rebobinadora X">
        </div>

        <div>
          <label>Motorista</label>
          <input name="motorista_saida" placeholder="Nome do motorista">
        </div>

        <div style="grid-column: 1 / -1;">
          <label>Observação</label>
          <input name="observacao" placeholder="Ex: saiu com urgência...">
        </div>

        <div style="grid-column: 1 / -1; text-align:right;">
          <button class="btn btn-primary" type="submit">
            Registrar Saída
          </button>
        </div>

      </form>
    </div>

    <!-- RETORNO -->
    <div class="card">
      <h3 style="margin-top:0;">Registrar Retorno</h3>

      <form method="POST" action="/motores/<%= motor.id %>/retorno" class="form-grid">

        <div>
          <label>Motorista</label>
          <input name="motorista_retorno" placeholder="Nome do motorista">
        </div>

        <div style="grid-column: 1 / -1;">
          <label>Observação</label>
          <input name="observacao" placeholder="Ex: retornou testado...">
        </div>

        <div style="grid-column: 1 / -1; text-align:right;">
          <button class="btn btn-primary" type="submit">
            Registrar Retorno
          </button>
        </div>

      </form>
    </div>

  </div>


  <!-- HISTÓRICO -->
  <div class="card" style="margin-top:20px;">
    <h3 style="margin-top:0;">Histórico</h3>

    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tipo</th>
          <th>Data</th>
          <th>Detalhes</th>
        </tr>
      </thead>
      <tbody>

        <% if (!eventos || !eventos.length) { %>
          <tr>
            <td colspan="4" style="text-align:center;">Sem histórico.</td>
          </tr>
        <% } %>

        <% eventos.forEach(e => { %>
          <tr>
            <td><%= e.id %></td>
            <td><%= e.tipo %></td>
            <td><%= e.created_at %></td>
            <td>
              <% if (e.payloadObj) { %>
                <div style="font-size:13px; color:#555;">
                  <% Object.keys(e.payloadObj).forEach(key => { %>
                    <div><b><%= key %>:</b> <%= e.payloadObj[key] %></div>
                  <% }) %>
                </div>
              <% } else { %>
                -
              <% } %>
            </td>
          </tr>
        <% }) %>

      </tbody>
    </table>
  </div>

</div>

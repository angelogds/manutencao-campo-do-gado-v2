<% layout('layout') %>
<div class="page-head"><div><h1>Solicitação #<%= sol.id %></h1><p class="muted">Fluxo: aberta → em cotação → liberada → aprovada para compra → comprada/recebida.</p></div></div>
<div class="card" style="margin-bottom:14px;">
  <div class="grid-3">
    <div><div class="label">Solicitante</div><strong><%= sol.solicitante %></strong></div>
    <div><div class="label">Origem</div><strong><%= sol.tipo_origem || 'AVULSA' %> <%= sol.origem_id ? ('#'+sol.origem_id) : '' %></strong></div>
    <div><div class="label">Destino</div><strong><%= sol.equipamento_nome || sol.destino_uso || '-' %></strong></div>
  </div>
  <form method="POST" action="/solicitacoes/<%= sol.id %>/status" style="margin-top:12px; display:flex; gap:8px; align-items:end;">
    <div><div class="label">Status</div><select class="input" name="status"><% ['aberta','em_cotacao','liberada','aprovada_compra','comprada','recebida','cancelada'].forEach(st=>{ %><option value="<%= st %>" <%= sol.status===st?'selected':'' %>><%= st %></option><% }) %></select></div>
    <button class="btn btn-green">Atualizar</button>
    <a class="btn" href="/compras/nova?solicitacao_id=<%= sol.id %>">Enviar para Compras</a>
  </form>
</div>
<div class="card" style="margin-bottom:14px;"><div class="label">Itens e saldo em estoque</div><div class="table-wrap"><table class="table"><thead><tr><th>Item</th><th>Descrição/Medida</th><th>Qtd</th><th>Un</th><th>Saldo atual</th></tr></thead><tbody><% (sol.itens||[]).forEach(it=>{ %><tr><td><%= it.estoque_nome || it.descricao %></td><td><%= it.especificacao || '-' %></td><td><%= it.quantidade %></td><td><%= it.unidade %></td><td><%= it.item_id ? it.saldo_atual : '-' %></td></tr><% }) %></tbody></table></div></div>
<div class="card"><div class="label">Cotações (mínimo recomendado: 2 ou 3)</div>
<form method="POST" action="/solicitacoes/<%= sol.id %>/cotacoes" class="grid-4" style="margin-top:10px;"><input class="input" name="fornecedor" placeholder="Fornecedor" required/><input class="input" name="valor_total" type="number" step="0.01" placeholder="Valor total" required/><input class="input" name="anexo_path" placeholder="Anexo (PDF/foto - caminho)"/><input class="input" name="observacao" placeholder="Obs."/><button class="btn btn-green" style="grid-column:1/-1;">Adicionar cotação</button></form>
<div class="table-wrap" style="margin-top:10px;"><table class="table"><thead><tr><th>Fornecedor</th><th>Valor</th><th>Anexo</th><th>Data</th></tr></thead><tbody><% if (!sol.cotacoes?.length){ %><tr><td colspan="4" style="text-align:center;color:#6b7280;">Sem cotações.</td></tr><% } %><% (sol.cotacoes||[]).forEach(c=>{ %><tr><td><%= c.fornecedor %></td><td>R$ <%= Number(c.valor_total||0).toFixed(2) %></td><td><%= c.anexo_path || '-' %></td><td><%= fmtBR(c.created_at) %></td></tr><% }) %></tbody></table></div>
</div>
